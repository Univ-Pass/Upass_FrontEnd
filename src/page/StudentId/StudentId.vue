<template>
	<div>
		<Toast :style="{ width: '90%', zIndex: '2100' }" />

		<Header :title="'U-PASS'" />
		<div class="container bg-gray">
			<div>
				<div class="student-content">
					<HeaderSection :title="'학생증'" :subtitle="'자신의 정보를 간편하게 관리해보세요.'" />
					<Dialog class="QR-modal" :showHeader="false" v-model:visible="displayStudentModal" :style="{ width: '80vw' }">
						<div class="student-info">
							<div class="student-card">
								<div class="student-wrapper">
									<div class="box">
										<div class="student-card__item">
											<p class="item__univ">경기대학교</p>
											<div class="item__img">
												<!-- <img class="student__img" src="../../assets/KakaoTalk_20210418_124638504.jpg" /> -->

												<div class="student__img" :style="{ 'background-image': 'url(' + image + ')' }"></div>
											</div>
											<p class="item__detail">학번 : {{ studentId }}</p>
											<p class="item__detail">성명 : {{ name }}</p>
											<p class="item__detail">소속(학과) : {{ major }}</p>
										</div>
									</div>
								</div>
							</div>

							<Dialog class="QR-modal" header="Header" :showHeader="false" v-model:visible="displayQRModal" :style="{ width: '80vw' }" :modal="true">
								<QRVerification @goBack="closeQRModal" :isStudentId="true" :DIDPasswd="DIDPasswd" />
							</Dialog>
							<Dialog class="password-modal p-dialog-maximized" header="" v-model:visible="displayPasswordModal" :style="{ width: '100vw', height: '100vh' }" :modal="true">
								<SimplePassword :title="'간편 비밀번호 입력'" :isSetting="false" @correctPassword="closePasswordModal" />
							</Dialog>
							<Dialog class="password-modal p-dialog-maximized" header="" v-model:visible="displayPasswordModalForNone" :style="{ width: '100vw', height: '100vh' }" :modal="true">
								<SimplePassword :title="'간편 비밀번호 설정'" :isSetting="true" @setCorrectPassword="closePasswordModalForNone" />
							</Dialog>
						</div>
					</Dialog>
					<div class="student__id-content"></div>
					<div class="student__button">
						<Button label="학생증" icon="pi pi-id-card" iconPos="left" @click="openPasswordModal" />
					</div>
				</div>
				<Dialog class="did__error-modal" header="" :showHeader="false" v-model:visible="displayDIDModal" :style="{ width: '80vw' }" :modal="true">
					<div class="did-modal">
						<div class="did-card">
							<div class="did-wrapper">
								<div class="box">
									<div class="did-card__item">
										<p class="item__title">학생증 발급 필요</p>
										<p class="item__detail">
											<br />DID (Decentralized Identifier)을 발급하는 도중에 오류가 발생하였거나, 어플이 종료되었을 수 있습니다. <br /><br />
											기기에 DID정보가 없으므로 학생증을 발급해주세요.<br />
										</p>

										<Button label="학생증 발급" icon="pi pi-user-plus" iconPos="right" class="p-button-outlined did-issued" @click="getUserDID" />
									</div>
								</div>
							</div>
						</div>
					</div>
				</Dialog>
			</div>
		</div>
	</div>
	<BottomNav />
</template>
<script>
import QRVerification from "../../components/QRVerification/QRVerification"
import HeaderSection from "../../components/HeaderSection/HeaderSection"
import SimplePassword from "../../components/SimplePasswd/SimplePasswd"
import { SHA256 } from "../../sha256.js"
export default {
	name: "StudentId",
	components: {
		QRVerification,
		HeaderSection,
		SimplePassword,
	},
	data() {
		return {
			displayQRModal: false,
			displayPasswordModal: false,
			displayPasswordModalForNone: false,
			displayStudentModal: false,
			displayDIDModal: false,
			image: "",
			name: "",
			major: "",
			studentId: "",
			DID: localStorage.getItem("did"),
			SimplePassword: localStorage.getItem("simplePassword"),
			key: localStorage.getItem("key"),
			DIDPasswd: "",
		}
	},
	created() {
		this.setQRString()
		this.getMember()
		this.image = localStorage.getItem("image")
		console.log(this.image)
	},
	mounted() {
		if (localStorage.getItem("simplePassword") === null) this.openPasswordModalForNone()
		if (localStorage.getItem("did") === null) this.openDIDModal()
		this.displayStudentModal = true
		this.$shared.checkGoogleLogin(this.$gAuth)
	},
	methods: {
		async getMember() {
			try {
				const response = await this.$axios.get("/api/members/" + this.key, {})
				if (response.status === 201) {
					this.name = response.data.name
					this.studentId = response.data.stdnum
					this.major = response.data.major
					// localStorage.setItem("did", response.data.did)
				}
			} catch (error) {
				if (error.response) {
					// 요청이 이루어졌으며 서버가 2xx의 범위를 벗어나는 상태 코드로 응답했습니다.
					// console.log(error.response.data)
					// console.log(error.response.status)
					// console.log(error.response.headers)
				}
			}
		},
		async getUserDID() {
			try {
				const response = await this.$axios.get("/api/runpython/", {})
				if (response.status === 201) {
					localStorage.setItem("did", response.data.did)
				}
			} catch (error) {
				if (error.response) {
					this.summaryText = "DID발급 오류"
					this.detailText = "죄송합니다. \nDID 발급에 오류가 있습니다."
					this.showError(this.summaryText, this.detailText)
				}
			}
		},
		setQRString() {
			this.DIDPasswd = SHA256(this.did + this.SimplePassword)
		},
		openQRModal() {
			this.displayQRModal = true
		},
		closeQRModal() {
			this.displayQRModal = false
		},
		openPasswordModal() {
			this.displayPasswordModal = true
		},
		closePasswordModal() {
			this.openQRModal()
			this.displayPasswordModal = false
		},
		openPasswordModalForNone() {
			this.displayPasswordModalForNone = true
		},
		closePasswordModalForNone() {
			this.displayPasswordModalForNone = false
		},
		openDIDModal() {
			this.displayDIDModal = true
		},
		closeDIDModal() {
			this.displayDIDModal = false
		},
	},
}
</script>
<style scoped>
@import "./student-id.css";
</style>
<style>
.p-dialog {
	border-radius: 20px;
}
.p-dialog.p-component.QR-modal {
	overflow: hidden;
	border-radius: 20px;
	box-shadow: 0 0 5px rgba(0, 0, 0, 0.05), 0 5px 20px rgba(0, 0, 0, 0.05);
}
.p-dialog.p-component.did__error-modal {
	overflow: hidden;
	border-radius: 20px;
	box-shadow: 0 0 5px rgba(0, 0, 0, 0.05), 0 5px 20px rgba(0, 0, 0, 0.05);
}
.p-dialog.p-component.password-modal.p-dialog-maximized .p-dialog-content {
	padding: 0 !important;
}
</style>
