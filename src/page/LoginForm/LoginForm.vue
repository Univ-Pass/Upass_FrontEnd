<template>
	<div class="login__Form-container">
		<Toast :style="{ width: '90%' }" />
		<Dialog class="login-form" v-model:visible="displayBasic" :showHeader="false" position="bottom" :style="{ width: '80vw' }">
			<!-- 회원가입 정보 입력 화면 -->
			<div class="login__form-box">
				<div class="p-fluid">
					<div class="sign-in">
						<div class="p-field">
							<label for="studentId" ref="usernameInput" class="studentId">학번 *</label>
							<InputText ref="studentId" :class="{ 'p-invalid': failId }" autocomplete="off" id="studentId" placeholder="학번" type="text" :maxlength="9" v-model="studentId" :disabled="successSignUp" />
							<small v-if="failId" class="p-error" id="studentid-help">{{ failIdText }}</small>
							<small v-else id="studentid-help">학번을 입력해주세요.</small>
						</div>
						<div class="p-field">
							<label for="id" class="studentId" ref="majorInput">학과 *</label>
							<Dropdown
								:disabled="successSignUp"
								v-model="selectedGroupedMajor"
								:options="groupedMajor"
								optionLabel="label"
								placeholder="학과를 선택해주세요."
								optionGroupLabel="label"
								optionGroupChildren="items"
								:class="{ 'major-invalid': failMajor }"
							>
								<template #optiongroup="slotProps">
									<div class="p-d-flex p-ai-center country-item">
										<div>{{ slotProps.option.label }}</div>
									</div>
								</template>
							</Dropdown>
							<small v-if="failMajor" class="p-error" id="studentid-help">{{ failMajorText }}</small>
							<small v-else id="usermajor-help">학과를 선택해주세요.</small>
						</div>
						<Button v-if="find === 'true'" label="학생증 찾기" icon="pi pi-search" iconPos="right" :class="{ 'p-button-outlined': !successSignUp }" :disabled="successSignUp" @click="checkValidate" />
						<div v-else>
							<Button label="회원 가입" icon="pi pi-check" iconPos="right" :class="{ 'p-button-outlined': !successSignUp }" :disabled="successSignUp" @click="checkValidate" />
							<Button label="학생증 발급" icon="pi pi-user-plus" iconPos="right" class="p-button-outlined did-issued" :disabled="!successSignUp" @click="getUserDID" />
						</div>
					</div>
				</div>
			</div>
		</Dialog>
		<Dialog class="password-modal p-dialog-maximized" :showHeader="false" v-model:visible="displayPasswordModal" :style="{ width: '100vw', height: '100vh' }" :modal="true">
			<SimplePassword :title="'간편 비밀번호 설정'" :isSetting="true" @setCorrectPassword="closePasswordModal" />
		</Dialog>
	</div>
</template>
<script>
import SimplePassword from "../../components/SimplePasswd/SimplePasswd"

export default {
	name: "LoginForm",
	components: { SimplePassword },
	props: { name: String, imgUrl: String, email: String, find: null },
	data() {
		return {
			studentId: "",
			failId: false,
			failIdText: "",
			failMajor: false,
			failMajorText: "",
			selectedGroupedMajor: null,
			displayPasswordModal: false,
			displayBasic: false,
			successSignUp: false,
			//임시 학과 데이터
			groupedMajor: [
				{
					label: "소프트웨어경영대학",
					code: "SE",
					items: [
						{ label: "국제산업정보학과", value: "국제산업정보학과" },
						{ label: "경영학과", value: "경영학과" },
						{ label: "컴퓨터공학부", value: "컴퓨터공학부" },
						{ label: "융합보안학과", value: "융합보안학과" },
						{ label: "산업경영공학과", value: "산업경영공학과" },
					],
				},
			],
			members: {
				name: "",
				studentId: "",
				major: "",
				userImage: "",
			},
		}
	},
	mounted() {
		setTimeout(() => {
			this.openBasicModal()
		}, 600)
	},
	methods: {
		setMembers() {
			this.members.name = this.name
			this.members.studentId = this.studentId
			this.members.major = this.selectedGroupedMajor.label
			this.members.userImage = this.imgUrl
			localStorage.setItem("members", JSON.stringify(this.members))
		},
		//유효성 검사
		checkValidate() {
			let regexp = /^[0-9]*$/
			if (this.studentId === "") {
				this.failId = true
				this.failIdText = "필수 입력 사항입니다."
				this.$refs.usernameInput.focus()
				return
			} else if (!regexp.test(this.studentId) || this.studentId.length !== 9) {
				this.failId = true
				this.failIdText = "9자리 숫자를 입력해주세요."
				this.$refs.usernameInput.focus()
				return
			} else if (this.selectedGroupedMajor === null) {
				this.failId = false
				this.failMajor = true
				this.$refs.majorInput.focus()
				this.failMajorText = "필수 입력 사항입니다."
				return
			}
			this.failMajor = false
			if (this.find === "true") {
				this.findAccount()
			} else {
				this.signUp()
			}
		},
		//회원가입
		async signUp() {
			this.isFirstMember = false
			try {
				const response = await this.$axios.post(
					"/api/members/",
					{
						major: this.selectedGroupedMajor.label,
						stdnum: this.studentId,
						name: this.name,
						image: this.imgUrl,
						email: this.email,
					},
					{ params: { key: this.$sha256("이팔청춘의 U-PASS") } }
				)
				if (response.status === 201) {
					this.successSignUp = true
					this.showSuccess("회원가입 완료", "회원가입이 완료되었습니다. \n간편비밀번호를 설정해주세요.")
					this.setMembers()
					this.closeBasicModal()
					this.openPasswordModal()
				}
			} catch (error) {
				if (error.response) {
					//중복 회원가입시
					if (error.response.data.msg === "stdnum is already exists") {
						this.showError("회원가입 오류", "이미 등록된 학번입니다.")
						this.studentId = ""
						this.$refs.studentId.$el.focus()
					} else if (error.response.data.msg === "Email is already exists") {
						this.showError("회원가입 오류", "이미 등록된 이메일입니다.\n잠시후 메인 화면으로 이동합니다.")
						setTimeout(() => {
							this.$router.replace("/login")
						}, 3000)
					}
				}
			}
		},
		//did 발급
		async getUserDID() {
			try {
				const response = await this.$axios.get("/api/runpython/", { params: { key: localStorage.getItem("key"), email: this.email, SimplePassword: localStorage.getItem("simplePassword") } })
				if (response.status === 201) {
					localStorage.setItem("did", response.data.did)
					this.showSuccess("학생증 발급 완료", "학생증 발급이 완료되었습니다.")
					this.$router.replace("/")
				}
			} catch (error) {
				if (error.response) {
					this.showError("DID발급 오류", "죄송합니다. \nDID 발급에 오류가 있습니다.")
				}
			}
		},
		//회원 찾기
		async findAccount() {
			try {
				const response = await this.$axios.post("/api/findmyinfo/", { stdnum: this.studentId, email: this.email }, { params: { key: this.$sha256("이팔청춘의 U-PASS") } })
				if (response.status === 201) {
					this.showSuccess("회원 찾기 성공", "이미 가입된 회원입니다. \n잠시후 학생증 페이지로 이동합니다.")
					localStorage.setItem("key", response.data.email_hash)
					localStorage.setItem("did", response.data.did)
					this.setMembers()
					setTimeout(() => {
						this.$router.replace("/")
					}, 2000)
				}
			} catch (error) {
				if (error.response) {
					if (error.response.data.msg === "가입되지 않은 email입니다.") {
						this.showError("회원 찾기 오류", "가입된 정보가 없습니다. \n잠시후 메인 화면으로 돌아갑니다.")
						setTimeout(() => {
							this.$router.replace("/login")
						}, 2000)
					} else if (error.response.data.msg === "email과 stdnum이 일치하지 않습니다.") {
						this.showError("회원 찾기 오류", "해당되는 학번이 없습니다. \n확인 후 다시 입력해주세요.")
						this.studentId = ""
						this.$refs.studentId.$el.focus()
					}
				}
			}
		},
		openPasswordModal() {
			this.displayPasswordModal = true
		},
		closePasswordModal() {
			this.openBasicModal()
			this.showSuccess("간편비밀번호 설정 완료", "간편비밀번호 설정이 완료되었습니다. \n학생증을 발급해주세요.")
			this.displayPasswordModal = false
		},
		openBasicModal() {
			this.displayBasic = true
		},
		closeBasicModal() {
			this.displayBasic = false
		},
		showError(summaryText, detailText) {
			this.$toast.add({ severity: "error", summary: summaryText, detail: detailText, life: 3000 })
		},
		showSuccess(summaryText, detailText) {
			this.$toast.add({ severity: "success", summary: summaryText, detail: detailText, life: 3000 })
		},
	},
}
</script>
<style scoped>
@import "./login-form.css";
</style>
<style>
.login-form .p-dialog-content {
	border-radius: 20px;
}
.p-toast .p-toast-message .p-toast-message-content .p-toast-detail {
	white-space: pre;
}
</style>
